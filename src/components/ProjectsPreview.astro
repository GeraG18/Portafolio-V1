---
import { getCollection } from "astro:content";
import LinkButton from './LinkButton.astro';

interface project {
    title: string;
    technologies: string[];
    urls: {name: string, url: string}[];
    image: string;
    startDate: string;
    endDate: string;
    role: string;
    slug: string;
    body: string;
}

const textProccesor = (text: string) => text.replace(/(`(?:``)?).*?\1|[\\*_{}[\]()#+\-.!`]/g, '');

const projects = (await getCollection('projects')).map((item: any) => ({...item.data, slug: item.slug, body: textProccesor(item.body)}));
console.log('projects>', projects);

let lastProjects: project[] = projects.filter((item: any, index: any) => (index < 3));
// console.log('lastProjects>', lastProjects);

function filterTechnologies(value: string[]) {
    let array = value.filter((item, index) => (index < 3));
    value.length > 3 ? array.push(`Y ${value.length - 3} más`): undefined
    return array;
}

let buttonStyle = `
    inline-flex items-center justify-center gap-2 px-3 py-1 space-x-2 
    text-xl text-[--text] transition bg-transparent border border-[--text] 
    focus-visible:ring-[--accent-dark] text-md hover:bg-[--text]
    group rounded-full hover:text-[--background] focus:outline-none focus-visible:outline-none 
    focus-visible:ring focus-visible:ring-offset-2 !text-base
`;

---
<div class="w-full flex flex-col items-center justify-center gap-4">
    {lastProjects?.map(({title, technologies, urls, image, startDate, endDate, role, slug, body}) => (
        <div class="flex-none w-full h-full lg:h-[10rem] flex flex-col lg:flex-row gap-2 items-center justify-center">
            <div class="aspect-video relative rounded-lg h-[10rem] lg:h-full border border-[--text-gray] overflow-hidden group flex items-center justify-center">
                {/* <p class="two-line-trunc h-auto z-10 text-[--text] opacity-0 group-hover:opacity-100 transition-all !px-2">
                    {title}
                </p> */}
                <a href={`/projects/${slug}`} class="z-10 w-full h-full flex items-center justify-center cursor-pointer text-[--text] opacity-0 group-hover:opacity-100 transition-all">
                    Más detalles
                    <span class="material-symbols-rounded">
                        north_east
                    </span>
                </a>
                <div class="absolute z-[5] bg-[--backgroundRGBA] backdrop-blur-sm supports-[backdrop-filter]:bg-[--backgroundRGBA] transition-all w-full h-full top-0 left-0 opacity-0 group-hover:opacity-100"></div>
                {
                image ? 
                <img src={image} alt="" 
                class="absolute grayscale inset-0 h-full w-full object-cover group-hover:scale-110 group-hover:grayscale-0 transition-transform duration-500 ease-in-out !border-none"/>
                : 
                <div class="absolute bg-gray-200 w-full h-full text-[--text] flex flex-col items-center justify-center">
                    <span class="material-symbols-rounded text-2xl">
                        image
                    </span>
                    <span>Sin imagen</span>
                </div>
                }
            </div>
            <div class="w-full h-full flex flex-col items-start justify-center">
                <span class="font-semibold">{title}</span>
                <div class="w-full flex gap-2 text-sm items-center justify-start overflow-y-auto overflow-x-hidden">
                    {filterTechnologies(technologies)?.map((tech, index) => (
                        <span class="capitalize px-2 border-[1px] border-[--accent-darker] rounded-full !text-[--accent-darker] flex-none flex items-center justify-center gap-1"> 
                            <i class={"icon icon-"+tech}></i>
                            {tech.replace('-',' ')}
                        </span>
                    ))}
                </div>
                <p class="flex-none text-lg mb-[2px] two-line-trunc" set:html={body ? body : 'No hay una descripción'}>
                    
                </p>
                <div class="flex-none w-full flex flex-col lg:flex-row items-center justify-start gap-2">
                    <a href={`/projects/${slug}`} class={buttonStyle+' w-full lg:w-auto'}>
                        Detalles
                        <span class="material-symbols-rounded">
                            north_east
                        </span>
                    </a>
                    {
                        urls.length > 0
                        ?
                        <div class="hidden lg:block w-[1px] h-[70%] bg-[--text-gray]"></div>
                        :
                        ""
                    }
                    {urls.map(({name, url}) => (
                    <LinkButton  target="_blank" width="[14rem]" extraClasses="!text-base !py-1 w-full lg:w-auto" id="linkedinButton" href={url}>
                        {name} 
                        <span class="material-symbols-rounded">
                            captive_portal
                        </span>
                    </LinkButton>
                    ))}

                </div>
            </div>
        </div>
    ))}

</div>

<style>
    .text-truncate {
        -webkit-line-clamp: 2;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>